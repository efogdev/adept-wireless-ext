<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><title>WiFi Setup</title><meta name="theme-color" content="#4CAF50"><style>body{font-family:Arial,sans-serif;max-width:600px;margin:0 auto;padding:12px}h1{text-align:center;color:#333}.container{border:1px solid #ddd;border-radius:5px;padding:20px;margin-top:20px}.form-group{margin-bottom:15px}label{display:block;margin-bottom:5px;font-weight:700}input,select{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;box-sizing:border-box}input[type=checkbox]{width:auto;position:relative;top:2px}button{background-color:#4caf50;color:#fff;padding:10px 15px;border:none;border-radius:4px;cursor:pointer;font-size:16px;margin-right:6px}.secondary{background-color:#6c757d}button:hover{background-color:#45a049}button:disabled{background-color:#ccc;cursor:not-allowed}.status{margin-bottom:12px;padding:10px;border-radius:4px;display:none}.success{background-color:#dff0d8;color:#3c763d}.error{background-color:#f2dede;color:#a94442}.info{background-color:#d9edf7;color:#31708f}.loading{text-align:center;padding:20px}.spinner{border:4px solid rgba(0,0,0,.1);width:20px;height:20px;border-radius:50%;border-left-color:#09f;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle;margin-right:10px;margin-left:8px}.loading .spinner{width:36px;height:36px;margin-bottom:10px;margin-right:0;margin-left:0;vertical-align:initial}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.hidden{display:none}.fg-spacer{height:12px;min-height:12px}input#manualSsidInput{margin-bottom:2px}</style></head><body><h1>WiFi Setup</h1><div id="loadingContainer" class="loading hidden"><div class="spinner"></div><p>Connecting to device...</p></div><div id="mainContainer" class="container"><div id="status" class="status info"></div><div class="form-group"><button id="settingsBtn" class="secondary">Settings</button> <button id="disableWebStackBtn" style="background-color:#d5706e">Stop WiFi</button> <button id="rebootBtn" style="background-color:#d5706e">Reboot</button><div class="fg-spacer"></div></div><div class="form-group"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px"><label for="networkSelect">Network:</label> <label style="font-weight:400"><input type="checkbox" id="manualSsidCheckbox"> Enter SSID</label></div><select id="networkSelect" disabled="disabled"><option value="">--- Select a network ---</option></select> <input id="manualSsidInput" placeholder="Enter SSID manually" class="hidden"></div><div class="form-group"><label for="passwordInput">Password:</label> <input type="password" id="passwordInput" disabled="disabled"></div><div class="form-group"><button id="connectBtn" disabled="disabled">Connect</button> <button id="scanBtn" class="secondary">Scan</button> <span id="actionSpinner" class="spinner hidden"></span></div></div><script>const loadingContainer=document.getElementById("loadingContainer"),mainContainer=document.getElementById("mainContainer"),scanBtn=document.getElementById("scanBtn"),networkSelect=document.getElementById("networkSelect"),manualSsidCheckbox=document.getElementById("manualSsidCheckbox"),manualSsidInput=document.getElementById("manualSsidInput"),passwordInput=document.getElementById("passwordInput"),connectBtn=document.getElementById("connectBtn"),actionSpinner=document.getElementById("actionSpinner"),statusDiv=document.getElementById("status");let socket=null,reconnectAttempts=0;const maxReconnectAttempts=125;let lastMessageTime=0,wsCheckInterval=null,isConnectedToWifi=!1;function connectWebSocket(){loadingContainer.classList.remove("hidden"),mainContainer.classList.add("hidden");const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/ws`;socket=new WebSocket(e),socket.onopen=function(){console.log("WebSocket connected"),loadingContainer.classList.add("hidden"),mainContainer.classList.remove("hidden"),reconnectAttempts>0&&(actionSpinner.classList.add("hidden"),scanBtn.disabled=!1),reconnectAttempts=0,lastMessageTime=Date.now(),wsCheckInterval&&clearInterval(wsCheckInterval),wsCheckInterval=setInterval(checkWebSocketActivity,1e3),checkSavedCredentials()},socket.onclose=function(){if(console.log("WebSocket disconnected"),wsCheckInterval&&(clearInterval(wsCheckInterval),wsCheckInterval=null),!isConnectedToWifi&&reconnectAttempts<125){reconnectAttempts++,loadingContainer.classList.remove("hidden"),mainContainer.classList.add("hidden");const e=loadingContainer.querySelector("p");e&&(e.textContent="Waiting for connection..."),setTimeout(connectWebSocket,1e3)}},socket.onerror=function(e){console.error("WebSocket error:",e);const t=loadingContainer.querySelector("p");t&&(t.textContent="Waiting for connection...")},socket.onmessage=function(e){lastMessageTime=Date.now(),handleWebSocketMessage(e.data)}}function handleWebSocketMessage(e){try{const t=JSON.parse(e);switch(t.type){case"wifi_scan_result":handleWifiScanResult(t.content);break;case"wifi_connect_status":handleWifiConnectStatus(t.content);break;case"wifi_saved_credentials":handleSavedCredentials(t.content);break;case"log":console.log("Server log:",t.content);break;case"ping":break;case"web_stack_disabled":updateStatus("WiFi disabled. You can close this tab.","success");break;case"reboot":updateStatus("Device is rebooting.","info");break;default:console.log("Unknown message type:",t.type)}}catch(e){console.error("Error parsing WebSocket message:",e)}}function handleSavedCredentials(e){e?updateStatus("WiFi credentials present!","success"):scanWifiNetworks()}function handleWifiScanResult(e){for(actionSpinner.classList.add("hidden"),scanBtn.disabled=!1;networkSelect.options.length>1;)networkSelect.remove(1);e&&e.length>0?(e.forEach((e=>{const t=document.createElement("option");t.value=e.ssid;let n="";n=e.rssi>=-50?"excellent":e.rssi>=-60?"good":e.rssi>=-70?"fair":"bad",t.textContent=`${e.ssid} (${e.rssi} dBm, ${n})`,networkSelect.appendChild(t)})),manualSsidCheckbox.checked||(networkSelect.disabled=!1,passwordInput.disabled=!1,connectBtn.disabled=!1),updateStatus("","info")):updateStatus("No networks found. Try scanning again.","error")}function handleWifiConnectStatus(e){actionSpinner.classList.add("hidden"),e.connected?(isConnectedToWifi=!0,updateStatus("Successfully connected! The device is restarting. \n\n You can connect to the regular WiFi network. \n\n You will be automatically redirected to the new address soon.","success"),wsCheckInterval&&(clearInterval(wsCheckInterval),wsCheckInterval=null),loadingContainer.classList.add("hidden"),mainContainer.classList.remove("hidden"),setTimeout((()=>{window.location.href=`http://${e.ip}`}),15e3)):e.attempt<3?updateStatus("Connection failed. Retrying...","error"):(updateStatus("Failed to connect after 3 attempts. Please try again with different credentials.","error"),connectBtn.disabled=!1)}function updateStatus(e,t){statusDiv.style.display=e?"block":"none",statusDiv.textContent=e,statusDiv.className=`status ${t}`}function checkSavedCredentials(){socket&&socket.readyState===WebSocket.OPEN?socket.send(JSON.stringify({type:"wifi_check_saved"})):updateStatus("Device not connected. Please refresh the page.","error")}function scanWifiNetworks(){socket&&socket.readyState===WebSocket.OPEN?(scanBtn.disabled=!0,actionSpinner.classList.remove("hidden"),updateStatus("","info"),socket.send(JSON.stringify({type:"wifi_scan"}))):updateStatus("Device not connected. Please refresh the page.","error")}function connectToWifi(){let e;if(manualSsidCheckbox.checked){if(e=manualSsidInput.value.trim(),!e)return void updateStatus("Please enter an SSID.","error")}else if(e=networkSelect.value,!e)return void updateStatus("Please select a network.","error");const t=passwordInput.value;socket&&socket.readyState===WebSocket.OPEN?(connectBtn.disabled=!0,actionSpinner.classList.remove("hidden"),updateStatus("Connecting to network...","info"),socket.send(JSON.stringify({type:"wifi_connect",content:{ssid:e,password:t}}))):updateStatus("Device not connected. Please refresh the page.","error")}function checkWebSocketActivity(){const e=Date.now();if(!isConnectedToWifi&&e-lastMessageTime>3500){loadingContainer.classList.remove("hidden"),mainContainer.classList.add("hidden");const e=loadingContainer.querySelector("p");e&&(e.textContent="Waiting for connection..."),socket&&socket.close()}}scanBtn.addEventListener("click",scanWifiNetworks),connectBtn.addEventListener("click",connectToWifi),manualSsidCheckbox.addEventListener("change",(function(){if(this.checked)networkSelect.classList.add("hidden"),manualSsidInput.classList.remove("hidden"),passwordInput.disabled=!1,connectBtn.disabled=!1;else{networkSelect.classList.remove("hidden"),manualSsidInput.classList.add("hidden");const e=""!==networkSelect.value;passwordInput.disabled=!e,connectBtn.disabled=!e}})),document.getElementById("settingsBtn").addEventListener("click",(function(){window.location.href="/settings"})),document.getElementById("disableWebStackBtn").addEventListener("click",(function(){if(confirm("Are you sure you want to disable WiFi and web stack?")){if(!socket||socket.readyState!==WebSocket.OPEN)return void updateStatus("Device not connected. Please refresh the page.","error");updateStatus("Disabling WiFi and web stack...","info"),socket.send(JSON.stringify({type:"disable_web_stack"}))}})),document.getElementById("rebootBtn").addEventListener("click",(function(){const e=confirm('Do you want to keep WiFi and web stack on after reboot? Press "Ok" to keep it enabled.');socket&&socket.readyState===WebSocket.OPEN?(updateStatus("Rebooting device...","info"),socket.send(JSON.stringify({type:"reboot",content:{keepWifi:e}}))):updateStatus("Device not connected. Please refresh the page.","error")})),window.addEventListener("load",connectWebSocket)</script></body></html>