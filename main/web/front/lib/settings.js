var A=Object.defineProperty,H=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var x=Object.getOwnPropertySymbols;var _=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var O=(a,o,r)=>o in a?A(a,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[o]=r,u=(a,o)=>{for(var r in o||(o={}))_.call(o,r)&&O(a,r,o[r]);if(x)for(var r of x(o))G.call(o,r)&&O(a,r,o[r]);return a},b=(a,o)=>H(a,V(o));const App=()=>{var P,E;const[a,o]=React.useState(!1),[r,p]=React.useState(!0),[S,N]=React.useState(null),[y,k]=React.useState(0),[T,W]=React.useState({freeHeap:0,socTemp:0}),[n,R]=React.useState({deviceInfo:{name:"TBD",firmwareVersion:"TBD",hardwareVersion:"TBD",macAddress:"00:00:00:00:00:00"},power:{sleepTimeout:60,deepSleepTimeout:180,lowPowerMode:!1,enableSleep:!0,deepSleep:!0,separateSleepTimeouts:!0},led:{brightness:80},connectivity:{bleTxPower:"low",bleReconnectDelay:3}}),[D,C]=React.useState(null),[M,U]=React.useState("info"),[B,I]=React.useState(0),[g,f]=React.useState(!1),c=React.useRef(null),w=React.useRef(null),h=React.useRef(null),m=React.useRef(null),F=()=>{const e=Date.now();if(y>0&&e-y>1500){if(o(!1),p(!0),c.current&&c.current.readyState!==WebSocket.CLOSED)try{c.current.close()}catch(t){console.error("Error closing socket:",t)}setTimeout(v,1e3)}};React.useEffect(()=>(v(),w.current=setInterval(F,1e3),()=>{c.current&&c.current.close(),w.current&&clearInterval(w.current)}),[]);const v=()=>{p(!0),N(null);const t=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`,s=new WebSocket(t);c.current=s,s.onopen=()=>{console.log("WebSocket connected"),o(!0),p(!1),k(Date.now()),$()},s.onclose=()=>{console.log("WebSocket disconnected"),o(!1),p(!0),setTimeout(v,1e3)},s.onerror=i=>{console.error("WebSocket error:",i),N("Failed to connect to the device. Please try again later."),p(!1)},s.onmessage=i=>{L(i.data)}},L=e=>{k(Date.now());try{const t=JSON.parse(e);switch(t.type){case"ota_progress":if(t.content&&t.content.progress!==void 0){const s=typeof t.content=="string"?JSON.parse(t.content).progress:t.content.progress;I(s),s===100&&(l("OTA update completed successfully! Device will reboot.","success"),setTimeout(()=>{f(!1)},2e3))}break;case"settings":if(t.content){const s=u(u({},n),t.content);R(s),m.current||(m.current=JSON.stringify(s))}break;case"settings_update_status":t.content.success?l("Settings updated successfully. The device is restarting.","success"):l(`Failed to update settings: ${t.content.error}`,"error");break;case"log":console.log("Server log:",t.content);break;case"ping":if(t.content)try{const s=typeof t.content=="string"?JSON.parse(t.content):t.content;W({freeHeap:s.freeHeap||0,socTemp:s.socTemp||0})}catch(s){console.error("Error parsing ping data:",s)}break;default:console.log("Unknown message type:",t.type)}}catch(t){console.error("Error parsing WebSocket message:",t)}},$=()=>{if(!c.current||c.current.readyState!==WebSocket.OPEN){l("WebSocket not connected.","error");return}c.current.send(JSON.stringify({type:"command",command:"get_settings"}))},J=()=>{if(!c.current||c.current.readyState!==WebSocket.OPEN){l("WebSocket not connected.","error");return}c.current.send(JSON.stringify({type:"command",command:"update_settings",content:n})),l("Saving settings...","info")},d=(e,t,s)=>{R(i=>{if(e==="power"){if(t==="sleepTimeout"&&(s<20||s>1800))return l("Sleep timeout must be between 20 and 1800 seconds.","error"),i;if(t==="deepSleepTimeout"){if(s<20||s>99999)return l("Deep sleep timeout must be between 20 and 99999 seconds.","error"),i;if(i.power.separateSleepTimeouts&&s<=i.power.sleepTimeout)return l("Deep sleep timeout must be greater than sleep timeout.","error"),i}}return b(u({},i),{[e]:b(u({},i[e]),{[t]:s})})})},l=(e,t)=>{C(e),U(t),window.scrollTo(0,0),setTimeout(()=>{C(null)},15e3)};return r||!a?React.createElement("div",{id:"loadingContainer"},React.createElement("div",{className:"spinner"}),React.createElement("p",null,a?"Loading settings":"Waiting for connection...")):S?React.createElement("div",{className:"container"},React.createElement("div",{className:"status error"},S),React.createElement("button",{onClick:v},"Retry Connection")):React.createElement("div",null,React.createElement("h1",null,"Device Settings"),React.createElement("div",{className:"container"},D&&React.createElement("div",{className:`status ${M}`},D),React.createElement("button",{onClick:J,disabled:!a||g||m.current&&JSON.stringify(n)===m.current},"Save & Reboot"),React.createElement("button",{onClick:()=>window.location.href="/",style:{marginLeft:"10px",backgroundColor:"#6c757d"},disabled:g},"Return"),React.createElement("div",{className:"setting-group"},React.createElement("h2",null,"Device Information"),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Firmware version"),React.createElement("div",null,n.deviceInfo.firmwareVersion)),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Hardware revision"),React.createElement("div",null,n.deviceInfo.hardwareVersion)),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"MAC address"),React.createElement("div",null,n.deviceInfo.macAddress)),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Free heap"),React.createElement("div",null,(T.freeHeap/1e3).toFixed(0)," kb")),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"SoC temperature"),React.createElement("div",null,T.socTemp.toFixed(0),"\xB0C"))),React.createElement("div",{className:"setting-group"},React.createElement("h2",null,"Power Management"),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Low power mode"),React.createElement("div",{className:"setting-description"},"Sacrifice performance to improve battery life. Makes BLE interval to be ~12-15ms instead of 7.5ms. Makes RGB LEDs to update with 60FPS instead of 120FPS."),React.createElement("label",{className:"toggle-switch"},React.createElement("input",{type:"checkbox",checked:n.power.lowPowerMode,onChange:e=>d("power","lowPowerMode",e.target.checked)}),React.createElement("span",{className:"slider"}))),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Enable sleep"),React.createElement("div",{className:"setting-description"},"Enable device to enter sleep mode and disable Bluetooth when no events received in the time window."),React.createElement("label",{className:"toggle-switch"},React.createElement("input",{type:"checkbox",checked:n.power.enableSleep,onChange:e=>d("power","enableSleep",e.target.checked)}),React.createElement("span",{className:"slider"}))),React.createElement("div",{className:n.power.enableSleep?"animate-visible":"animate-hidden"},React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Deep sleep"),React.createElement("div",{className:"setting-description"},"When enabled, USB device will not be able to wake up the device. You will have to press any button on the device itself."),React.createElement("label",{className:"toggle-switch"},React.createElement("input",{type:"checkbox",checked:n.power.deepSleep,onChange:e=>d("power","deepSleep",e.target.checked)}),React.createElement("span",{className:"slider"}))),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Separate sleep timeouts"),React.createElement("div",{className:"setting-description"},"If disabled, the device will go into the deep sleep immediately after entering light sleep."),React.createElement("label",{className:"toggle-switch"},React.createElement("input",{type:"checkbox",checked:n.power.separateSleepTimeouts,onChange:e=>d("power","separateSleepTimeouts",e.target.checked)}),React.createElement("span",{className:"slider"}))),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},n.power.separateSleepTimeouts?"Light sleep timeout":"Sleep timeout"),React.createElement("div",{className:"setting-description"},"Time without USB events in seconds before device enters light sleep mode. In light sleep, Bluetooth is turned off but the device still awaits for USB events to turn it on immediately."),React.createElement("input",{type:"number",min:"0",max:"3600",value:n.power.sleepTimeout,onChange:e=>d("power","sleepTimeout",parseInt(e.target.value))})),React.createElement("div",{className:`setting-item ${n.power.separateSleepTimeouts&&n.power.deepSleep?"animate-visible":"animate-hidden"}`},React.createElement("div",{className:"setting-title"},"Deep sleep timeout"),React.createElement("div",{className:"setting-description"},"Time without USB events in seconds before device enters deep sleep mode. In deep sleep, the device will do nothing and only wake up when you press any button on the bridge device itself."),React.createElement("input",{type:"number",min:"0",max:"3600",value:n.power.deepSleepTimeout,onChange:e=>d("power","deepSleepTimeout",parseInt(e.target.value))})))),React.createElement("div",{className:"setting-group"},React.createElement("h2",null,"Visuals"),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Brightness"),React.createElement("div",{className:"setting-description"},"Global LED brightness percentage."),React.createElement("input",{type:"range",min:"0",max:"100",value:n.led.brightness,onChange:e=>d("led","brightness",parseInt(e.target.value))}))),React.createElement("div",{className:"setting-group"},React.createElement("h2",null,"Connectivity"),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"BLE TX power"),React.createElement("div",{className:"setting-description"},"Bluetooth transmission power level."),React.createElement("select",{value:n.connectivity.bleTxPower,onChange:e=>d("connectivity","bleTxPower",e.target.value)},React.createElement("option",{value:"n6"},"-6 dB"),React.createElement("option",{value:"n3"},"-3 dB"),React.createElement("option",{value:"n0"},"0 dB"),React.createElement("option",{value:"p3"},"+3 dB"),React.createElement("option",{value:"p6"},"+6 dB"),React.createElement("option",{value:"p9"},"+9 dB"))),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-title"},"Reconnect delay"),React.createElement("div",{className:"setting-description"},"Delay in seconds before attempting to reconnect after Bluetooth disconnect. Doesn't affect waking up from sleep."),React.createElement("input",{type:"number",min:"1",max:"60",value:n.connectivity.bleReconnectDelay,onChange:e=>d("connectivity","bleReconnectDelay",parseInt(e.target.value))}))),React.createElement("div",{className:"setting-group"},React.createElement("h2",null,"Firmware Update"),React.createElement("div",{className:"setting-item"},React.createElement("div",{className:"setting-description"},"Upload a new firmware file to update the device. The device will reboot after a successful update."),g?React.createElement("div",null,React.createElement("div",{className:"progress-container"},React.createElement("div",{className:"progress-bar",style:{width:`${B}%`}},B,"%")),React.createElement("p",null,"Uploading firmware...")):React.createElement("div",null,React.createElement("div",{className:"file-input-container"},React.createElement("input",{type:"file",ref:h,accept:".bin"})),React.createElement("button",{onClick:()=>{const e=h.current;if(!e||!e.files||e.files.length===0){l("Please select a firmware file","error");return}const t=e.files[0],s=new FormData;s.append("firmware",t),f(!0),I(0),l("Starting firmware upload...","info"),window.scrollTo(0,0),fetch("/upload",{method:"POST",body:s}).then(i=>{if(!i.ok)throw new Error(`HTTP error ${i.status}`);return i.text()}).then(i=>{console.log("Upload successful:",i)}).catch(i=>{console.error("Upload failed:",i),f(!1),l(`Upload failed: ${i.message}`,"error")})},disabled:!a||!((E=(P=h.current)==null?void 0:P.files)!=null&&E.length)},"Flash"))))))};ReactDOM.render(React.createElement(App,null),document.getElementById("root"));
